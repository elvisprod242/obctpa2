/**
 * @fileoverview Firestore Security Rules for AuthZenith.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data stored
 * under the `/users/{userId}` path. Only the authenticated user matching
 * the `userId` in the path can read or write their own data.
 * All authenticated users can read/write to the /partenaires, /conducteurs, /vehicules, /invariants, /rapports, /objectifs, /infractions, /infractionFiles, and /kpis collections.
 *
 * Data Structure:
 * All user data is stored under the `/users/{userId}` collection. Each
 * document represents a user profile and contains their email and
 * registration date.
 * Partner data is stored under the `/partenaires/{partenaireId}` collection.
 * Driver data is stored under the `/conducteurs/{conducteurId}` collection.
 * Vehicle data is stored under the `/vehicules/{vehiculeId}` collection.
 * Invariant data is stored under the `/invariants/{invariantId}` collection.
 * Report data is stored under the `/rapports/{rapportId}` collection.
 * Objective data is stored under the `/objectifs/{objectifId}` collection.
 * Infraction data is stored under the `/infractions/{infractionId}` collection.
 * Infraction file data is stored under the `/infractionFiles/{fileId}` collection.
 * KPI data is stored under the `/kpis/{kpiId}` collection.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for data stored under /users/{userId}.
     * @path /users/{userId}
     * @allow (create) - Authenticated user 'user_abc' can create their own profile document at /users/user_abc. The data must have 'id' = 'user_abc'.
     * @allow (get, update, delete) - Authenticated user 'user_abc' can get, update, and delete their own profile document at /users/user_abc.
     * @deny (create) - Authenticated user 'user_xyz' cannot create a document at /users/user_abc.
     * @deny (get, update, delete) - Authenticated user 'user_xyz' cannot get, update, or delete the document at /users/user_abc.
     * @principle Enforces strict user-ownership: Only the authenticated user can manage their own data.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing all users is not permitted.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
    
    /**
     * @description Authenticated users can manage partners.
     * @path /partenaires/{partenaireId}
     */
    match /partenaires/{partenaireId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage drivers.
     * @path /conducteurs/{conducteurId}
     */
    match /conducteurs/{conducteurId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage vehicles.
     * @path /vehicules/{vehiculeId}
     */
    match /vehicules/{vehiculeId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage invariants.
     * @path /invariants/{invariantId}
     */
    match /invariants/{invariantId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage reports.
     * @path /rapports/{rapportId}
     */
    match /rapports/{rapportId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage objectives.
     * @path /objectifs/{objectifId}
     */
    match /objectifs/{objectifId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage infractions.
     * @path /infractions/{infractionId}
     */
    match /infractions/{infractionId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage infraction files.
     * @path /infractionFiles/{fileId}
     */
    match /infractionFiles/{fileId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage KPIs.
     * @path /kpis/{kpiId}
     */
    match /kpis/{kpiId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage procedures.
     * @path /procedures/{procedureId}
     */
    match /procedures/{procedureId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage equipment.
     * @path /equipements/{equipementId}
     */
    match /equipements/{equipementId} {
        allow read, write: if isSignedIn();
    }
    
    /**
     * @description Authenticated users can manage work time analysis.
     * @path /temps_travail/{tempsTravailId}
     */
    match /temps_travail/{tempsTravailId} {
        allow read, write: if isSignedIn();
    }
    
    /**
     * @description Authenticated users can manage driving time analysis.
     * @path /temps_conduite/{tempsConduiteId}
     */
    match /temps_conduite/{tempsConduiteId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage resting time analysis.
     * @path /temps_repos/{tempsReposId}
     */
    match /temps_repos/{tempsReposId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage cabin checks.
     * @path /controle_cabine/{controleCabineId}
     */
    match /controle_cabine/{controleCabineId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage communication plans.
     * @path /planning_communications/{planningCommunicationId}
     */
    match /planning_communications/{planningCommunicationId} {
        allow read, write: if isSignedIn();
    }
    
    /**
     * @description Authenticated users can manage communication actions.
     * @path /communications/{communicationId}
     */
    match /communications/{communicationId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage SCP records.
     * @path /scp/{scpId}
     */
    match /scp/{scpId} {
        allow read, write: if isSignedIn();
    }

    /**
     * @description Authenticated users can manage OBC keys.
     * @path /cles_obc/{cleId}
     */
    match /cles_obc/{cleId} {
        allow read, write: if isSignedIn();
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is signed in and the UID matches, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner and the resource exists.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is signed in, the UID matches, and the resource exists.
     */
    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}

    